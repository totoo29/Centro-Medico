{% extends "base.html" %}

{% block title %}
    {% if cliente %}Editar Paciente{% else %}Nuevo Paciente{% endif %} - Consultorio M√©dico
{% endblock %}

{% block page_title %}
    {% if cliente %}Editar Paciente{% else %}Nuevo Paciente{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-{% if cliente %}edit{% else %}plus{% endif %}"></i>
                    {% if cliente %}Editar Paciente - {{ cliente.nombre_completo }}{% else %}Agregar Nuevo Paciente{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form id="formCliente" method="POST" 
                      action="{% if cliente %}{{ url_for('clientes.actualizar', id=cliente.id) }}{% else %}{{ url_for('clientes.crear') }}{% endif %}">
                    
                    <div class="row">
                        <!-- Nombre -->
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">
                                <i class="fas fa-user"></i> Nombre <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="nombre" name="nombre" 
                                   value="{{ cliente.nombre if cliente else '' }}" required>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- Apellido -->
                        <div class="col-md-6 mb-3">
                            <label for="apellido" class="form-label">
                                <i class="fas fa-user"></i> Apellido <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="apellido" name="apellido" 
                                   value="{{ cliente.apellido if cliente else '' }}" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Tel√©fono -->
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">
                                <i class="fas fa-phone"></i> Tel√©fono
                            </label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" 
                                   value="{{ cliente.telefono if cliente and cliente.telefono else '' }}"
                                   placeholder="+54 9 11 1234-5678">
                            <div class="form-text">Formato: +54 9 XX XXXX-XXXX (opcional)</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope"></i> Email
                            </label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ cliente.email if cliente and cliente.email else '' }}"
                                   placeholder="ejemplo@email.com">
                            <div class="form-text">Para env√≠o de recordatorios (opcional)</div>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Obra Social -->
                    <div class="card bg-light mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-hospital"></i> Informaci√≥n de Obra Social
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Obra Social -->
                                <div class="col-md-6 mb-3">
                                    <label for="obra_social_id" class="form-label">
                                        <i class="fas fa-hospital"></i> Obra Social
                                    </label>
                                    <select class="form-select" id="obra_social_id" name="obra_social_id">
                                        <option value="">Seleccionar obra social...</option>
                                        <option value="particular" {% if cliente and not cliente.obra_social_id %}selected{% endif %}>Particular</option>
                                    </select>
                                    <div class="form-text">Seleccione la obra social del paciente</div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Plan de Obra Social -->
                                <div class="col-md-6 mb-3">
                                    <label for="plan_id" class="form-label">
                                        <i class="fas fa-clipboard-list"></i> Plan
                                    </label>
                                    <select class="form-select" id="plan_id" name="plan_id" {% if not cliente or not cliente.obra_social_id %}disabled{% endif %}>
                                        <option value="">Seleccionar plan...</option>
                                    </select>
                                    <div class="form-text">Seleccione el plan correspondiente</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- N√∫mero de Afiliado -->
                                <div class="col-md-6 mb-3">
                                    <label for="numero_afiliado" class="form-label">
                                        <i class="fas fa-id-card"></i> N√∫mero de Afiliado
                                    </label>
                                    <input type="text" class="form-control" id="numero_afiliado" name="numero_afiliado" 
                                           value="{{ cliente.numero_afiliado if cliente and cliente.numero_afiliado else '' }}"
                                           placeholder="12345678">
                                    <div class="form-text">N√∫mero de afiliado a la obra social</div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <!-- Grupo Familiar -->
                                <div class="col-md-6 mb-3">
                                    <label for="grupo_familiar" class="form-label">
                                        <i class="fas fa-users"></i> Grupo Familiar
                                    </label>
                                    <input type="text" class="form-control" id="grupo_familiar" name="grupo_familiar" 
                                           value="{{ cliente.grupo_familiar if cliente and cliente.grupo_familiar else '' }}"
                                           placeholder="Titular, C√≥nyuge, Hijo, etc.">
                                    <div class="form-text">Rol en el grupo familiar</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <!-- Titular del Grupo Familiar -->
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="titular_id" class="form-label">
                                        <i class="fas fa-user-tie"></i> Titular del Grupo Familiar
                                    </label>
                                    <select class="form-select" id="titular_id" name="titular_id">
                                        <option value="">Sin titular (es titular)</option>
                                    </select>
                                    <div class="form-text">Seleccione si es familiar de otro paciente</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vista previa de la informaci√≥n -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-eye"></i> Vista Previa
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Nombre Completo:</strong><br>
                                            <span id="previewNombre" class="text-muted">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Contacto:</strong><br>
                                            <span id="previewContacto" class="text-muted">-</span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <strong>Obra Social:</strong><br>
                                            <span id="previewObraSocial" class="text-muted">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Plan:</strong><br>
                                            <span id="previewPlan" class="text-muted">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('clientes.listar') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Volver a la Lista
                                </a>
                                
                                <div>
                                    {% if cliente %}
                                        <a href="{{ url_for('clientes.detalle', id=cliente.id) }}" class="btn btn-outline-info me-2">
                                            <i class="fas fa-eye"></i> Ver Detalle
                                        </a>
                                    {% endif %}
                                    
                                    <button type="button" class="btn btn-outline-warning me-2" onclick="limpiarFormulario()">
                                        <i class="fas fa-eraser"></i> Limpiar
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success" id="btnGuardar">
                                        <i class="fas fa-save"></i> 
                                        {% if cliente %}Actualizar Paciente{% else %}Guardar Paciente{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Informaci√≥n Importante
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success"></i> Campos Obligatorios</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-dot-circle fa-xs"></i> Nombre</li>
                            <li><i class="fas fa-dot-circle fa-xs"></i> Apellido</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-shield-alt text-info"></i> Privacidad</h6>
                        <p class="small text-muted">
                            Los datos del paciente est√°n protegidos y solo ser√°n utilizados 
                            para fines m√©dicos y administrativos del consultorio.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% if cliente %}
        <!-- Historial del paciente -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-history"></i> Informaci√≥n del Registro
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Fecha de Registro:</strong><br>
                        <span class="text-muted">
                            {{ cliente.fecha_creacion.strftime('%d/%m/%Y a las %H:%M') if cliente.fecha_creacion else 'No disponible' }}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>ID del Paciente:</strong><br>
                        <span class="badge bg-secondary">#{{ cliente.id }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let obrasSociales = [];
let planes = [];
let clientes = [];

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    cargarObrasSociales();
    cargarClientes();
    
    const campos = {
        nombre: document.getElementById('nombre'),
        apellido: document.getElementById('apellido'),
        telefono: document.getElementById('telefono'),
        email: document.getElementById('email'),
        obra_social_id: document.getElementById('obra_social_id'),
        plan_id: document.getElementById('plan_id'),
        numero_afiliado: document.getElementById('numero_afiliado'),
        grupo_familiar: document.getElementById('grupo_familiar'),
        titular_id: document.getElementById('titular_id')
    };

    // Actualizar vista previa cuando cambian los campos
    Object.values(campos).forEach(campo => {
        campo.addEventListener('input', actualizarVistaPrevia);
        campo.addEventListener('change', actualizarVistaPrevia);
        if (campo.id !== 'titular_id') {
            campo.addEventListener('blur', validarCampo);
        }
    });

    // Eventos especiales
    document.getElementById('obra_social_id').addEventListener('change', onObraSocialChange);
    document.getElementById('plan_id').addEventListener('change', onPlanChange);

    // Actualizar vista previa inicial
    actualizarVistaPrevia();
    
    // Cargar datos del cliente si estamos editando
    {% if cliente %}
        cargarDatosCliente();
    {% endif %}
});

// Cargar obras sociales desde la API
async function cargarObrasSociales() {
    try {
        const response = await fetch('/obras-sociales/api/listar');
        if (response.ok) {
            obrasSociales = await response.json();
            poblarObrasSociales();
        }
    } catch (error) {
        console.error('Error al cargar obras sociales:', error);
    }
}

// Cargar clientes para el campo titular
async function cargarClientes() {
    try {
        const response = await fetch('/clientes/buscar?limit=100');
        if (response.ok) {
            clientes = await response.json();
            poblarClientes();
        }
    } catch (error) {
        console.error('Error al cargar clientes:', error);
    }
}

// Poblar select de obras sociales
function poblarObrasSociales() {
    const select = document.getElementById('obra_social_id');
    const valorActual = select.value;
    
    // Mantener la opci√≥n "Particular"
    select.innerHTML = '<option value="">Seleccionar obra social...</option><option value="particular">Particular</option>';
    
    obrasSociales.forEach(obra => {
        if (obra.activo) {
            const option = document.createElement('option');
            option.value = obra.id;
            option.textContent = `${obra.nombre} (${obra.codigo})`;
            if (obra.id == valorActual) {
                option.selected = true;
            }
            select.appendChild(option);
        }
    });
}

// Poblar select de clientes
function poblarClientes() {
    const select = document.getElementById('titular_id');
    const valorActual = select.value;
    
    select.innerHTML = '<option value="">Sin titular (es titular)</option>';
    
    clientes.forEach(cliente => {
        if (cliente.activo && cliente.id != '{{ cliente.id if cliente else 0 }}') {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = `${cliente.nombre} ${cliente.apellido}`;
            if (cliente.id == valorActual) {
                option.selected = true;
            }
            select.appendChild(option);
        }
    });
}

// Cuando cambia la obra social
async function onObraSocialChange() {
    const obraSocialId = document.getElementById('obra_social_id').value;
    const planSelect = document.getElementById('plan_id');
    
    // Limpiar planes
    planSelect.innerHTML = '<option value="">Seleccionar plan...</option>';
    planSelect.disabled = true;
    
    if (obraSocialId && obraSocialId !== 'particular') {
        try {
            const response = await fetch(`/obras-sociales/${obraSocialId}/planes/api`);
            if (response.ok) {
                planes = await response.json();
                poblarPlanes();
                planSelect.disabled = false;
            }
        } catch (error) {
            console.error('Error al cargar planes:', error);
        }
    }
    
    actualizarVistaPrevia();
}

// Poblar select de planes
function poblarPlanes() {
    const select = document.getElementById('plan_id');
    const valorActual = select.value;
    
    select.innerHTML = '<option value="">Seleccionar plan...</option>';
    
    planes.forEach(plan => {
        if (plan.activo) {
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = `${plan.nombre} - ${plan.cobertura_display}`;
            if (plan.id == valorActual) {
                option.selected = true;
            }
            select.appendChild(option);
        }
    });
}

// Cuando cambia el plan
function onPlanChange() {
    actualizarVistaPrevia();
}

// Cargar datos del cliente para edici√≥n
function cargarDatosCliente() {
    const cliente = {
        obra_social_id: '{{ cliente.obra_social_id if cliente and cliente.obra_social_id else "" }}',
        plan_id: '{{ cliente.plan_id if cliente and cliente.plan_id else "" }}',
        numero_afiliado: '{{ cliente.numero_afiliado if cliente and cliente.numero_afiliado else "" }}',
        grupo_familiar: '{{ cliente.grupo_familiar if cliente and cliente.grupo_familiar else "" }}',
        titular_id: '{{ cliente.titular_id if cliente and cliente.titular_id else "" }}'
    };
    
    // Establecer valores
    if (cliente.obra_social_id) {
        document.getElementById('obra_social_id').value = cliente.obra_social_id;
        onObraSocialChange();
    }
    
    if (cliente.plan_id) {
        setTimeout(() => {
            document.getElementById('plan_id').value = cliente.plan_id;
        }, 500);
    }
    
    if (cliente.numero_afiliado) {
        document.getElementById('numero_afiliado').value = cliente.numero_afiliado;
    }
    
    if (cliente.grupo_familiar) {
        document.getElementById('grupo_familiar').value = cliente.grupo_familiar;
    }
    
    if (cliente.titular_id) {
        setTimeout(() => {
            document.getElementById('titular_id').value = cliente.titular_id;
        }, 500);
    }
}

// Actualizar vista previa
function actualizarVistaPrevia() {
    const nombre = document.getElementById('nombre').value.trim();
    const apellido = document.getElementById('apellido').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const email = document.getElementById('email').value.trim();
    const obraSocialId = document.getElementById('obra_social_id').value;
    const planId = document.getElementById('plan_id').value;

    // Nombre completo
    const nombreCompleto = [nombre, apellido].filter(x => x).join(' ') || 'Sin nombre';
    document.getElementById('previewNombre').textContent = nombreCompleto;

    // Contacto
    const contactos = [];
    if (telefono) contactos.push(`üìû ${telefono}`);
    if (email) contactos.push(`üìß ${email}`);
    
    document.getElementById('previewContacto').textContent = 
        contactos.length > 0 ? contactos.join(' | ') : 'Sin datos de contacto';

    // Obra Social
    let obraSocialText = 'Sin obra social';
    if (obraSocialId === 'particular') {
        obraSocialText = 'Particular';
    } else if (obraSocialId) {
        const obra = obrasSociales.find(o => o.id == obraSocialId);
        obraSocialText = obra ? obra.nombre : 'Obra social seleccionada';
    }
    document.getElementById('previewObraSocial').textContent = obraSocialText;

    // Plan
    let planText = 'Sin plan';
    if (planId) {
        const plan = planes.find(p => p.id == planId);
        planText = plan ? `${plan.nombre} (${plan.cobertura_display})` : 'Plan seleccionado';
    }
    document.getElementById('previewPlan').textContent = planText;
}

// Validaci√≥n en tiempo real y vista previa
function validarCampo(event) {
    const campo = event.target;
    const valor = campo.value.trim();
    
    // Limpiar validaciones previas
    campo.classList.remove('is-valid', 'is-invalid');
    const feedback = campo.nextElementSibling;
    if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = '';
    }

    // Validaciones espec√≠ficas
    switch (campo.id) {
        case 'nombre':
        case 'apellido':
            if (!valor) {
                mostrarError(campo, 'Este campo es obligatorio');
                return false;
            }
            if (valor.length < 2) {
                mostrarError(campo, 'Debe tener al menos 2 caracteres');
                return false;
            }
            break;

        case 'telefono':
            if (valor && !validarTelefono(valor)) {
                mostrarError(campo, 'Formato de tel√©fono no v√°lido');
                return false;
            }
            break;

        case 'email':
            if (valor && !validarEmail(valor)) {
                mostrarError(campo, 'Formato de email no v√°lido');
                return false;
            }
            break;
            
        case 'numero_afiliado':
            if (valor && valor.length < 3) {
                mostrarError(campo, 'El n√∫mero de afiliado debe tener al menos 3 caracteres');
                return false;
            }
            break;
    }

    // Campo v√°lido
    campo.classList.add('is-valid');
    return true;
}

function mostrarError(campo, mensaje) {
    campo.classList.add('is-invalid');
    const feedback = campo.nextElementSibling;
    if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = mensaje;
    }
}

function validarTelefono(telefono) {
    // Acepta varios formatos de tel√©fono argentino
    const patterns = [
        /^\+54\s?9?\s?\d{2,4}\s?\d{4}-?\d{4}$/,  // +54 9 11 1234-5678
        /^\d{2,4}\s?\d{4}-?\d{4}$/,               // 11 1234-5678
        /^\d{8,10}$/                              // 1112345678
    ];
    
    return patterns.some(pattern => pattern.test(telefono));
}

function validarEmail(email) {
    const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return pattern.test(email);
}

function limpiarFormulario() {
    if (confirm('¬øEst√° seguro de que desea limpiar todos los campos?')) {
        document.getElementById('formCliente').reset();
        
        // Limpiar validaciones
        document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
        });
        
        // Limpiar campos de obra social
        document.getElementById('plan_id').innerHTML = '<option value="">Seleccionar plan...</option>';
        document.getElementById('plan_id').disabled = true;
        
        // Actualizar vista previa
        actualizarVistaPrevia();
        
        // Focus en primer campo
        document.getElementById('nombre').focus();
    }
}

// Env√≠o del formulario
document.getElementById('formCliente').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validar todos los campos
    const campos = ['nombre', 'apellido', 'telefono', 'email'];
    let todoValido = true;
    
    campos.forEach(id => {
        const campo = document.getElementById(id);
        if (!validarCampo({target: campo})) {
            todoValido = false;
        }
    });
    
    if (!todoValido) {
        alert('Por favor, corrija los errores en el formulario');
        return;
    }
    
    // Mostrar loading
    const btnGuardar = document.getElementById('btnGuardar');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<span class="loading"></span> Guardando...';
    btnGuardar.disabled = true;
    
    // Enviar formulario
    const formData = new FormData(this);
    const url = this.action;
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.success) {
            // √âxito - redirigir
            window.location.href = "{{ url_for('clientes.listar') }}";
        } else if (data && data.error) {
            // Error del servidor
            alert('Error: ' + data.error);
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n. Por favor, intente nuevamente.');
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
});

// Formateo autom√°tico del tel√©fono
document.getElementById('telefono').addEventListener('input', function(e) {
    let valor = e.target.value.replace(/\D/g, ''); // Solo n√∫meros
    
    if (valor.startsWith('549')) {
        // Formato: +54 9 XX XXXX-XXXX
        valor = valor.substring(3);
        if (valor.length >= 2) {
            valor = `+54 9 ${valor.substring(0, 2)}${valor.length > 2 ? ' ' + valor.substring(2, 6) : ''}${valor.length > 6 ? '-' + valor.substring(6, 10) : ''}`;
        }
    } else if (valor.startsWith('54')) {
        // Formato: +54 XX XXXX-XXXX
        valor = valor.substring(2);
        if (valor.length >= 2) {
            valor = `+54 ${valor.substring(0, 2)}${valor.length > 2 ? ' ' + valor.substring(2, 6) : ''}${valor.length > 6 ? '-' + valor.substring(6, 10) : ''}`;
        }
    } else if (valor.length > 0) {
        // Formato local: XX XXXX-XXXX
        if (valor.length >= 2) {
            valor = `${valor.substring(0, 2)}${valor.length > 2 ? ' ' + valor.substring(2, 6) : ''}${valor.length > 6 ? '-' + valor.substring(6, 10) : ''}`;
        }
    }
    
    e.target.value = valor;
});

// Capitalizar nombres autom√°ticamente
function capitalizarNombre(input) {
    input.addEventListener('input', function(e) {
        const words = e.target.value.toLowerCase().split(' ');
        const capitalizedWords = words.map(word => {
            if (word.length > 0) {
                // No capitalizar preposiciones comunes
                const preposiciones = ['de', 'del', 'la', 'el', 'y', 'e'];
                if (preposiciones.includes(word)) {
                    return word;
                }
                return word.charAt(0).toUpperCase() + word.slice(1);
            }
            return word;
        });
        e.target.value = capitalizedWords.join(' ');
    });
}

capitalizarNombre(document.getElementById('nombre'));
capitalizarNombre(document.getElementById('apellido'));
</script>
{% endblock %}